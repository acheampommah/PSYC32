{
  "hash": "ec5c2555a56f407a353e949cca44e057",
  "result": {
    "markdown": "---\ntitle: \"Survival Analysis\"\n---\n\n\n\n\n\n## Survival analysis\n\n\n* So far, have seen:\n\n\n   * response variable counted or measured (regression)\n\n   * response variable categorized (logistic regression)\n\n* But what if response is time until event (eg. time of\nsurvival after surgery)?\n\n* Additional complication: event might not have happened at end of study (eg. patient still alive). But knowing that patient has \"not died yet\" presumably informative. Such data called *censored*. \n\n* Enter *survival analysis*, in particular the \"Cox proportional hazards model\". \n\n* Explanatory variables in this context often called *covariates*.\n\n\n## Packages\n\n* Install packages `survival` and `survminer` if not done. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(survminer)\nlibrary(broom)\nlibrary(marginaleffects)\n```\n:::\n\n\n\n\n## Example: still dancing?\n\n\n* 12 women who have just started taking dancing lessons are\nfollowed for up to a year, to see whether they are still taking\ndancing lessons, or have quit. The \"event\" here is \"quit\".\n\n* This might depend on:\n\n\n   * a treatment (visit to a dance competition)\n\n   * woman's age (at start of study).\n\n## Data\n\n\\normalsize\n```\nMonths  Quit   Treatment Age\n1        1        0      16\n2        1        0      24\n2        1        0      18\n3        0        0      27\n4        1        0      25\n7        1        1      26\n8        1        1      36\n10       1        1      38\n10       0        1      45\n12       1        1      47\n```\n\\normalsize\n\n## About the data\n\n\n* `months` and `quit` are kind of combined response:\n\n\n   *  `Months` is number of months a woman was actually observed dancing\n\n   * `quit` is 1 if woman quit, 0 if still dancing at end of study.\n\n\n* Treatment is 1 if woman went to dance competition, 0 otherwise.\n\n* Fit model and see whether `Age` or `Treatment`\nhave effect on survival.\n\n* Want to do predictions for probabilities of still dancing as\nthey depend on whatever is significant, and draw plot.\n\n\n## Read data \n\n\n- Column-aligned: \n\n\\normalsize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"http://ritsokiguess.site/datafiles/dancing.txt\"\ndance <- read_table(url)\n```\n:::\n\n\n\\normalsize\n\n\n## The data\n\n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 12 x 4\n   Months  Quit Treatment   Age\n    <dbl> <dbl>     <dbl> <dbl>\n 1      1     1         0    16\n 2      2     1         0    24\n 3      2     1         0    18\n 4      3     0         0    27\n 5      4     1         0    25\n 6      5     1         0    21\n 7     11     1         0    55\n 8      7     1         1    26\n 9      8     1         1    36\n10     10     1         1    38\n11     10     0         1    45\n12     12     1         1    47\n```\n:::\n:::\n\n\n\\normalsize\n   \n\n## Examine response and fit model\n\n\n* Response variable: \n\n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance %>% mutate(mth = Surv(Months, Quit)) -> dance\ndance\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 12 x 5\n   Months  Quit Treatment   Age    mth\n    <dbl> <dbl>     <dbl> <dbl> <Surv>\n 1      1     1         0    16     1 \n 2      2     1         0    24     2 \n 3      2     1         0    18     2 \n 4      3     0         0    27     3+\n 5      4     1         0    25     4 \n 6      5     1         0    21     5 \n 7     11     1         0    55    11 \n 8      7     1         1    26     7 \n 9      8     1         1    36     8 \n10     10     1         1    38    10 \n11     10     0         1    45    10+\n12     12     1         1    47    12 \n```\n:::\n:::\n\n\n\\normalsize\n\n\n  \n\n* Then fit model, predicting `mth` from explanatories:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance.1 <- coxph(mth ~ Treatment + Age, data = dance)\n```\n:::\n\n\n \n\n\n## Output looks a lot like regression\n\n\\scriptsize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dance.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = mth ~ Treatment + Age, data = dance)\n\n  n= 12, number of events= 10 \n\n              coef exp(coef) se(coef)      z Pr(>|z|)  \nTreatment -4.44915   0.01169  2.60929 -1.705   0.0882 .\nAge       -0.36619   0.69337  0.15381 -2.381   0.0173 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nTreatment   0.01169     85.554 7.026e-05    1.9444\nAge         0.69337      1.442 5.129e-01    0.9373\n\nConcordance= 0.964  (se = 0.039 )\nLikelihood ratio test= 21.68  on 2 df,   p=2e-05\nWald test            = 5.67  on 2 df,   p=0.06\nScore (logrank) test = 14.75  on 2 df,   p=6e-04\n```\n:::\n:::\n\n\n\\normalsize\n\n## Conclusions\n\n\n* Use $\\alpha=0.10$ here since not much data.\n\n* Three tests at bottom like global F-test. Consensus that\nsomething predicts survival time (whether or not dancer quit and how\nlong it took).\n\n* `Age` (definitely), `Treatment` (marginally) both\npredict survival time.\n\n\n## Model checking\n\n\n* With regression, usually plot residuals against fitted values.\n\n* Not quite same here (nonlinear model), but ``martingale\nresiduals'' should have no pattern vs.\\ \"linear predictor\".\n\n* `ggcoxdiagnostics` from package `survminer`\nmakes plot, to which we add smooth. If smooth trend more or less\nstraight across, model OK. \n\n* Martingale residuals can go very negative, so won't always\nlook normal.\n\n\n## Martingale residual plot for dance data\n\nThis looks good (with only 12 points):\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcoxdiagnostics(dance.1) + geom_smooth(se = F)\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-7-1.pdf)\n:::\n:::\n\n\n\n   \n\n## Predicted survival probs \n- The function we use is called\n`survfit`, though actually works rather like\n`predict`. \n- First create a data frame of values to predict from. We'll do all\ncombos of ages 20 and 40, treatment and not, using\n`crossing` to get all the combos:\n\n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntreatments <- c(0, 1)\nages <- c(20, 40)\ndance.new <- crossing(Treatment = treatments, Age = ages)\ndance.new\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 x 2\n  Treatment   Age\n      <dbl> <dbl>\n1         0    20\n2         0    40\n3         1    20\n4         1    40\n```\n:::\n:::\n\n\n\\normalsize \n\n## The predictions  \nOne prediction *for each time* for each combo of age and treatment in `dance.new`:\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns <- survfit(dance.1, newdata = dance.new, data = dance)\nsummary(s)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall: survfit(formula = dance.1, newdata = dance.new, data = dance)\n\n time n.risk n.event survival1 survival2 survival3 survival4\n    1     12       1  8.76e-01  1.00e+00  9.98e-01     1.000\n    2     11       2  3.99e-01  9.99e-01  9.89e-01     1.000\n    4      8       1  1.24e-01  9.99e-01  9.76e-01     1.000\n    5      7       1  2.93e-02  9.98e-01  9.60e-01     1.000\n    7      6       1 2.96e-323  6.13e-01  1.70e-04     0.994\n    8      5       1  0.00e+00  2.99e-06  1.35e-98     0.862\n   10      4       1  0.00e+00  0.00e+00  0.00e+00     0.000\n   11      2       1  0.00e+00  0.00e+00  0.00e+00     0.000\n   12      1       1  0.00e+00  0.00e+00  0.00e+00     0.000\n```\n:::\n:::\n\n\n\\normalsize\n\n\n\n## Conclusions from predicted probs\n\n\n* Older women more likely to be still dancing than younger women\n(compare \"profiles\" for same treatment group).\n\n* Effect of treatment seems to be to increase prob of still\ndancing (compare \"profiles\" for same age for treatment group\nvs.\\ not)\n\n* Would be nice to see this on a graph. This is `ggsurvplot` from package `survminer`:\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggsurvplot(s, conf.int = F)\n```\n:::\n\n\n\n## \"Strata\" (groups)\n\n- uses \"strata\" thus (`dance.new`): \n\n\\footnotesize\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 x 2\n  Treatment   Age\n      <dbl> <dbl>\n1         0    20\n2         0    40\n3         1    20\n4         1    40\n```\n:::\n:::\n\n\n\\normalsize\n\n\n\n\n## Plotting survival probabilities \n\n\n::: {.cell}\n\n```{.r .cell-code}\ng\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/survival-plot-1.pdf)\n:::\n:::\n\n\n\n   \n\n## Discussion \n\n\n* Survivor curve farther to the right is better (better chance\nof surviving longer).\n\n* Best is age 40 with treatment, worst age 20 without.\n\n* Appears to be: \n\n\n   * age effect (40 better than 20)\n\n   * treatment effect (treatment better than not)\n\n\n   * In analysis, treatment effect only marginally significant.\n\n\n## A more realistic example: lung cancer\n\n\n* When you\nload in an R package, get data sets to illustrate \nfunctions in the package. \n\n* One such is `lung`. Data\nset measuring survival in patients with advanced lung cancer. \n\n* Along with survival time, number of \"performance scores\"\nincluded, measuring how well patients can perform daily\nactivities.\n\n* Sometimes high good, but sometimes bad!\n\n* Variables below,\nfrom the data set help file  (`?lung`).\n\n\n## The variables\n\n![](lung-cancer-data.png)\n  \n\n## Uh oh, missing values\n\n\\scriptsize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung %>% slice(1:16)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss\n1     3  306      2  74   1       1       90       100     1175      NA\n2     3  455      2  68   1       0       90        90     1225      15\n3     3 1010      1  56   1       0       90        90       NA      15\n4     5  210      2  57   1       1       90        60     1150      11\n5     1  883      2  60   1       0      100        90       NA       0\n6    12 1022      1  74   1       1       50        80      513       0\n7     7  310      2  68   2       2       70        60      384      10\n8    11  361      2  71   2       2       60        80      538       1\n9     1  218      2  53   1       1       70        80      825      16\n10    7  166      2  61   1       2       70        70      271      34\n11    6  170      2  57   1       1       80        80     1025      27\n12   16  654      2  68   2       2       70        70       NA      23\n13   11  728      2  68   2       1       90        90       NA       5\n14   21   71      2  60   1      NA       60        70     1225      32\n15   12  567      2  57   1       1       80        70     2600      60\n16    1  144      2  67   1       1       80        90       NA      15\n```\n:::\n:::\n\n\n\\normalsize\n       \n\n## A closer look \n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\\tiny\n \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 166.8   1st Qu.:1.000   1st Qu.:56.00  \n Median :11.00   Median : 255.5   Median :2.000   Median :63.00  \n Mean   :11.09   Mean   : 305.2   Mean   :1.724   Mean   :62.45  \n 3rd Qu.:16.00   3rd Qu.: 396.5   3rd Qu.:2.000   3rd Qu.:69.00  \n Max.   :33.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n NA's   :1                                                       \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 75.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.395   Mean   :0.9515   Mean   : 81.94   Mean   : 79.96  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n                 NA's   :1        NA's   :1        NA's   :3       \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 635.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 928.8   Mean   :  9.832  \n 3rd Qu.:1150.0   3rd Qu.: 15.750  \n Max.   :2600.0   Max.   : 68.000  \n NA's   :47       NA's   :14       \n```\n:::\n:::\n\n\n\\normalsize\n\n   \n\n## Remove obs with *any* missing values \n\n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung %>% drop_na() -> lung.complete\nlung.complete %>%\n  select(meal.cal:wt.loss) %>%\n  slice(1:10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   meal.cal wt.loss\n2      1225      15\n4      1150      11\n6       513       0\n7       384      10\n8       538       1\n9       825      16\n10      271      34\n11     1025      27\n15     2600      60\n17     1150      -5\n```\n:::\n:::\n\n\n\\normalsize\n\n\n   \nMissing values seem to be gone.\n\n## Check! \n\\tiny\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung.complete)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 174.5   1st Qu.:1.000   1st Qu.:57.00  \n Median :11.00   Median : 268.0   Median :2.000   Median :64.00  \n Mean   :10.71   Mean   : 309.9   Mean   :1.719   Mean   :62.57  \n 3rd Qu.:15.00   3rd Qu.: 419.5   3rd Qu.:2.000   3rd Qu.:70.00  \n Max.   :32.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 70.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.383   Mean   :0.9581   Mean   : 82.04   Mean   : 79.58  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 619.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 929.1   Mean   :  9.719  \n 3rd Qu.:1162.5   3rd Qu.: 15.000  \n Max.   :2600.0   Max.   : 68.000  \n```\n:::\n:::\n\n\n\\normalsize\n\n\n   \nNo missing values left.\n\n## Model 1: use everything except `inst`\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(lung.complete)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"inst\"      \"time\"      \"status\"    \"age\"       \"sex\"      \n [6] \"ph.ecog\"   \"ph.karno\"  \"pat.karno\" \"meal.cal\"  \"wt.loss\"  \n```\n:::\n:::\n\n\n\\normalsize\n\n- Event was death, goes with `status` of 2:\n \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.complete %>% \n   mutate(resp = Surv(time, status == 2)) ->\n   lung.complete\nlung.1 <- coxph(resp ~ . - inst - time - status,\n  data = lung.complete\n)\n```\n:::\n\n\n \n\"Dot\" means \"all the other variables\".\n\n## `summary` of model 1\n\\tiny\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = resp ~ . - inst - time - status, data = lung.complete)\n\n  n= 167, number of events= 120 \n\n                coef  exp(coef)   se(coef)      z Pr(>|z|)   \nage        1.080e-02  1.011e+00  1.160e-02  0.931  0.35168   \nsex       -5.536e-01  5.749e-01  2.016e-01 -2.746  0.00603 **\nph.ecog    7.395e-01  2.095e+00  2.250e-01  3.287  0.00101 **\nph.karno   2.244e-02  1.023e+00  1.123e-02  1.998  0.04575 * \npat.karno -1.207e-02  9.880e-01  8.116e-03 -1.488  0.13685   \nmeal.cal   2.835e-05  1.000e+00  2.594e-04  0.109  0.91298   \nwt.loss   -1.420e-02  9.859e-01  7.766e-03 -1.828  0.06748 . \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nage          1.0109     0.9893    0.9881    1.0341\nsex          0.5749     1.7395    0.3872    0.8534\nph.ecog      2.0950     0.4773    1.3479    3.2560\nph.karno     1.0227     0.9778    1.0004    1.0455\npat.karno    0.9880     1.0121    0.9724    1.0038\nmeal.cal     1.0000     1.0000    0.9995    1.0005\nwt.loss      0.9859     1.0143    0.9710    1.0010\n\nConcordance= 0.653  (se = 0.029 )\nLikelihood ratio test= 28.16  on 7 df,   p=2e-04\nWald test            = 27.5  on 7 df,   p=3e-04\nScore (logrank) test = 28.31  on 7 df,   p=2e-04\n```\n:::\n:::\n\n\n\\normalsize\n\n \n\n## Overall significance\nThe three tests of overall significance: \n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglance(lung.1) %>% select(starts_with(\"p.value\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 x 4\n  p.value.log p.value.sc p.value.wald p.value.robust\n        <dbl>      <dbl>        <dbl>          <dbl>\n1    0.000205   0.000193     0.000271             NA\n```\n:::\n:::\n\n\n\\normalsize\n\n \nAll strongly significant. *Something* predicts survival. \n\n\n## Coefficients for model 1 \n\\small\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(lung.1) %>% select(term, p.value) %>% arrange(p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7 x 2\n  term      p.value\n  <chr>       <dbl>\n1 ph.ecog   0.00101\n2 sex       0.00603\n3 ph.karno  0.0457 \n4 wt.loss   0.0675 \n5 pat.karno 0.137  \n6 age       0.352  \n7 meal.cal  0.913  \n```\n:::\n:::\n\n\n\\normalsize\n\n \n\n\n* `sex` and\n`ph.ecog` definitely significant here \n\n* `age`, `pat.karno` and\n`meal.cal` definitely not\n\n* Take out definitely non-sig variables, and try again.\n\n\n## Model 2\n\\normalsize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.2 <- update(lung.1, . ~ . - age - pat.karno - meal.cal)\ntidy(lung.2) %>% select(term, p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 x 2\n  term      p.value\n  <chr>       <dbl>\n1 sex      0.00409 \n2 ph.ecog  0.000112\n3 ph.karno 0.101   \n4 wt.loss  0.108   \n```\n:::\n:::\n\n\n\\normalsize\n\n## Compare with first model: \n\n\\normalsize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(lung.2, lung.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n Cox model: response is  resp\n Model 1: ~ sex + ph.ecog + ph.karno + wt.loss\n Model 2: ~ (inst + time + status + age + sex + ph.ecog + ph.karno + pat.karno + meal.cal + wt.loss) - inst - time - status\n   loglik Chisq Df Pr(>|Chi|)\n1 -495.67                    \n2 -494.03 3.269  3      0.352\n```\n:::\n:::\n\n\n\\normalsize\n\n\n       \n\n* No harm in taking out those variables.\n\n\n## Model 3 \n\nTake out `ph.karno` and `wt.loss` as well. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.3 <- update(lung.2, . ~ . - ph.karno - wt.loss)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(lung.3) %>% select(term, estimate, p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 x 3\n  term    estimate  p.value\n  <chr>      <dbl>    <dbl>\n1 sex       -0.510 0.00958 \n2 ph.ecog    0.483 0.000266\n```\n:::\n:::\n\n\n \n\n## Check whether that was OK\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(lung.3, lung.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n Cox model: response is  resp\n Model 1: ~ sex + ph.ecog\n Model 2: ~ sex + ph.ecog + ph.karno + wt.loss\n   loglik  Chisq Df Pr(>|Chi|)  \n1 -498.38                       \n2 -495.67 5.4135  2    0.06675 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n\n*Just* OK. \n\n\n## Commentary\n\n\n* OK (just) to take out those two covariates.\n\n* Both remaining variables strongly significant.\n\n* Nature of effect on survival time? Consider later. \n\n* Picture?\n\n\n## Plotting survival probabilities\n\n\n* Create new data frame of values to predict for, then predict:\n\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsexes <- c(1, 2)\nph.ecogs <- 0:3\nlung.new <- datagrid(sex = sexes, ph.ecog = ph.ecogs, model = lung.3)\nlung.new\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  sex ph.ecog\n1   1       0\n2   1       1\n3   1       2\n4   1       3\n5   2       0\n6   2       1\n7   2       2\n8   2       3\n```\n:::\n:::\n\n\n\\normalsize\n\n \n\n## Making the plot \n\n\n::: {.cell}\n\n```{.r .cell-code}\ns <- survfit(lung.3, newdata = lung.new, data = lung)\ng <- ggsurvplot(s, conf.int = F)\n```\n:::\n\n\n \n## The plot\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-30-1.pdf)\n:::\n:::\n\n\n\n\n## Discussion of survival curves\n\n\n* Best survival is teal-blue curve, stratum 5, females with\n`ph.ecog` score 0.\n\n* Next best: blue, stratum 6, females with score 1, and\nred, stratum 1, males score 0.\n\n* Worst: green, stratum 4, males score 3.\n\n* For any given `ph.ecog` score, females have better\npredicted survival than males.\n\n* For both genders, a lower score associated with better\nsurvival.\n\n## The coefficients in model 3 \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(lung.3) %>% select(term, estimate, p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 x 3\n  term    estimate  p.value\n  <chr>      <dbl>    <dbl>\n1 sex       -0.510 0.00958 \n2 ph.ecog    0.483 0.000266\n```\n:::\n:::\n\n\n\n\n* `sex` coeff negative, so being higher\n`sex` value (female) goes with *less* hazard of dying.\n\n* `ph.ecog` coeff positive, so higher\n`ph.ecog` score goes with *more* hazard of dying\n\n* Two coeffs about same size, so being male rather than female\ncorresponds to 1-point increase in `ph.ecog` score. Note\nhow survival curves come in 3 pairs plus 2 odd.\n\n\n## Martingale residuals for this model\nNo problems here:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcoxdiagnostics(lung.3) + geom_smooth(se = F)\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-32-1.pdf)\n:::\n:::\n\n\n\n   \n\n## When the Cox model fails\n\n\n* Invent some data where survival is best at middling age, and\nworse at high *and* low age:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nage <- seq(20, 60, 5)\nsurvtime <- c(10, 12, 11, 21, 15, 20, 8, 9, 11)\nstat <- c(1, 1, 1, 1, 0, 1, 1, 1, 1)\nd <- tibble(age, survtime, stat)\nd %>% mutate(y = Surv(survtime, stat)) -> d\n```\n:::\n\n\n\n     \n\n* Small survival time 15 in middle was actually censored, so would\nhave been longer if observed.\n\n\n## Fit Cox model \n\n\\footnotesize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.1 <- coxph(y ~ age, data = d)\nsummary(y.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = y ~ age, data = d)\n\n  n= 9, number of events= 8 \n\n       coef exp(coef) se(coef)     z Pr(>|z|)\nage 0.01984   1.02003  0.03446 0.576    0.565\n\n    exp(coef) exp(-coef) lower .95 upper .95\nage      1.02     0.9804    0.9534     1.091\n\nConcordance= 0.545  (se = 0.105 )\nLikelihood ratio test= 0.33  on 1 df,   p=0.6\nWald test            = 0.33  on 1 df,   p=0.6\nScore (logrank) test = 0.33  on 1 df,   p=0.6\n```\n:::\n:::\n\n\n\\normalsize\n\n   \n\n## Martingale residuals \n\nDown-and-up indicates incorrect relationship between age and\nsurvival: \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcoxdiagnostics(y.1) + geom_smooth(se = F)\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-35-1.pdf)\n:::\n:::\n\n\n\n   \n\n## Attempt 2\n\nAdd squared term in age:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.2 <- coxph(y ~ age + I(age^2), data = d)\ntidy(y.2) %>% select(term, estimate, p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 x 3\n  term     estimate p.value\n  <chr>       <dbl>   <dbl>\n1 age      -0.380    0.116 \n2 I(age^2)  0.00483  0.0977\n```\n:::\n:::\n\n\n\n- (Marginally) helpful.\n       \n\n## Martingale residuals this time \n\nNot great, but less problematic than before:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcoxdiagnostics(y.2) + geom_smooth(se = F)\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-37-1.pdf)\n:::\n:::\n",
    "supporting": [
      "survival_files/figure-beamer"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}